machine:
  services:
    - docker

checkout:
  post:
    # workaround for known git bug where attempting to fetch a missing commit fails early on the first try
    - git submodule update --init --recursive || true
    - git submodule sync --recursive
    - git submodule deinit -f .
    - git submodule update --init --recursive --force

dependencies:
  pre:
    - docker pull px4io/px4-dev-nuttx
    - sudo pip install cpp-coveralls
    - sudo apt-get install -y lcov
    - gem install coveralls-lcov

test:
  override:
    - mkdir -p ~/.ccache
    - make distclean
    - PX4_DOCKER=1 make tests_coverage
    # copy test results for circleci
    - mkdir -p $CIRCLE_TEST_REPORTS/unittests/ && cp build_unittest/test_detail.xml $CIRCLE_TEST_REPORTS/unittests/
    - mkdir -p $CIRCLE_TEST_REPORTS/sitlunittests/ && cp ./build_posix_sitl_default/JUnitTestResults.xml $CIRCLE_TEST_REPORTS/sitlunittests/
    - cpp-coveralls -l coverage.info

general:
  artifacts:
    - "coverage-html"
    - "coverage.info"

